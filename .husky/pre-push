#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "[DEBUG] pre-push 훅 시작: $(date)"
echo "[DEBUG] 현재 디렉토리: $(pwd)"

# 프론트엔드 E2E 테스트 실행
echo "[husky] 프론트엔드 E2E 테스트를 실행합니다."
cd frontend

# 로컬 서버 시작 (백그라운드에서 실행)
echo "[DEBUG] 로컬 개발 서버 시작..."
npm run dev -- --port 5173 &
SERVER_PID=$!

# 서버가 시작될 때까지 잠시 대기
echo "[DEBUG] 서버 시작 대기 중..."
sleep 5

# E2E 테스트 실행
echo "[DEBUG] E2E 테스트 실행 중..."
npx playwright test --project=chromium

# 테스트 결과 저장
TEST_RESULT=$?

# 로컬 서버 종료
echo "[DEBUG] 로컬 서버 종료 중..."
kill $SERVER_PID

cd ..
echo "[DEBUG] 루트 디렉토리로 복귀: $(pwd)"

# 테스트 결과에 따라 push 허용 여부 결정
if [ $TEST_RESULT -ne 0 ]; then
  echo "[husky] E2E 테스트 실패! Push가 중단되었습니다."
  echo "[husky] 테스트 보고서를 확인하려면 'npx playwright show-report'를 실행하세요."
  exit 1
else
  echo "[husky] E2E 테스트 성공! Push를 진행합니다."
fi

echo "[DEBUG] pre-push 훅 종료: $(date)"
echo "[DEBUG] 훅 종료 코드: 0 (성공)"

exit 0
